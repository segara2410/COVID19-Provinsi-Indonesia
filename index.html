<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      .map-wrapper 
      {
        position: relative;
        height: 80vh;
      }

      #map 
      {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  </head>
  <body>
    <div class="card">
      <div class="card-header text-center">
        <h1>Peta Penyebaran COVID-19 Indonesia</h1>
      </div>
      <div class="card-body">
        <div class="map-wrapper">
          <div id="map"></div>
        </div>
      </div>
    </div>
  </body>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  <script type="text/javascript">
    var map = L.map('map').setView({lon: 117.9213, lat: -1.7893}, 5);

    // add the OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    }).addTo(map);

    // show the scale bar on the lower left corner
    L.control.scale().addTo(map);
    
    var provinsi = new Object();
    $.ajaxSetup({async: false});
    $.getJSON('https://api.kawalcorona.com/indonesia/provinsi/', function(data) 
    { 
      for (datum in data)
      {
        var new_object = data[datum].attributes;
        var provinsi_name = new_object["Provinsi"].toUpperCase();
        provinsi[provinsi_name] = Object.assign({},
        {
          positif : new_object["Kasus_Posi"],
          sembuh : new_object["Kasus_Semb"],
          meninggal : new_object["Kasus_Meni"],
        })
      }
      // provinsi = data;
    });

    function popUp(f,l)
    {
      var out = [];
      if (f.properties)
      {
        out.push("Provinsi: " + f.properties['Propinsi']);
        var current_provinsi = provinsi[`${f.properties['Propinsi']}`];

        if (current_provinsi)
        {
          out.push("Positif: " + current_provinsi.positif);
          out.push("Sembuh: " + current_provinsi.sembuh);
          out.push("Meninggal: " + current_provinsi.meninggal);
        }

        l.bindPopup(out.join("<br />"));
      }
    }

    function categorycolor(f){
      var current_provinsi = provinsi[`${f.properties['Propinsi']}`];
      
      var positif = 0;

      if (current_provinsi)
      {
        positif = current_provinsi.positif;
        
        if(positif > 10000) 
        {
          color = '#DC143C';
          return color;
        }
        else if (positif > 1000)
        {
          color = '#FFA500';
          return color;
        }
        else if (positif > 0)
        {
          color = '#FFFF33';
          return color;
        }
        else if (!positif)
        {
          color = '#00cc00';
          return color;
        }
      }
      else { //abu-abu
        color = '#A9A9A9';
        return color;
      }
    }

    function stylecolor(feature) 
    {
        return {
            fillColor: categorycolor(feature),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7
        };
    }

    var geojsonLayer = new L.GeoJSON.AJAX(["assets/json/indonesia-province.json"], {onEachFeature:popUp, style:stylecolor});       
    geojsonLayer.addTo(map);
  </script>
</html>